

while(1) {

    client = accept_client()

    child_pid = fork()

    /////////// CHILD

    shared_secret_key = diffieHellman(client)

    while(1) {
        encrypted_command = read(client)

        command = decrypt(encrypted_command, shared_secret_key)

        check_result = check_sum(command)

        if(check_result == bad_sum) {
            print(connection compromised, something is modifying your packets)
            exit() // kill the child, connection compromised
        }

        
        output = popen(command)

        while(chunk = get_chunk(output)) {

            add_checksum(chunk)

            encrypted_answer = encrypt(chunk, shared_secret_key)

            write(encrypted_answer)

        }

        answer_end = '\r\r\r'

        add_checksum(answer_end)

        encrypted_answer_end = encrypt(answer_end, shared_secret_key)

        write(encrypted_answer_end)

    }





    return 0
    //////////// CHILD END

    close(client)
}
