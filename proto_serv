
while(1) {

    client = accept_client()

    child_pid = fork()

    /////////// CHILD

    public_key = read_public_key(client)

    symmetric_key = create_symmetric_key()

    answer = public_key_encrypt(symmetric_key)

    // authenticate user

    while(1) {
        encrypted_answer = encrypt(answer, symmetric_key)

        command = decrypt(encrypted_answer)

        result = search_in_database(command)

        if(result == user_found) {
            break
        }
        else {
            send_error(client)
            
        }

    }

    while(1) {
        encrypted_command = read(client)

        command = decrypt(encrypted_command, symmetric_key)

        check_result = check_sum(command)

        if(check_result == bad_sum) {
            print(connection compromised, something is modifying your packets)
            exit() // kill the child, connection compromised
        }

        output = popen(command)



        while(chunk = get_chunk(output)) {

            add_checksum(chunk)

            encrypted_answer = encrypt(chunk, symmetric_key)

            write(encrypted_answer)

        }

        answer_end = '\r\r\r'

        add_checksum(answer_end)

        encrypted_answer_end = encrypt(answer_end, symmetric_key)

        write(encrypted_answer_end)

    }





    return 0
    //////////// CHILD END

    close(client)
}
